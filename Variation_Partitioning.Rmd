---
title: "Variation Partitioning Analysis"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
author: "Briana K. Whitaker"
date: "`r Sys.Date()`"
---
\fontsize{9}{10}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning =FALSE, message=FALSE)
```
---


* Run using `r version[['version.string']] `.

# Objective
This document reports on the **variation partitioning analysis** for the Variety Sampling mycobiome data from samples collected in 2020 and 2021 in Ewing and Urbana Illinois. 


```{r, echo=FALSE, results='hide', include=FALSE} 
x<-c("ggplot2", "phyloseq", "vegan" , "dplyr", "DESeq2", "egg")
lapply(x, require, character.only = TRUE)

#Load functions
source("./code/multiplot.function.R")
#add 'not in' function
`%nin%` = Negate(`%in%`)
# geometric mean
gm_mean_protected <- function(x) {
  if (all(x == 0)) {
    return (0)
  }
  exp(mean(log(x[x != 0])))
}

#set seed
set.seed(215)

# set ggplot2 theme
theme_set(theme_bw(base_size=10)) 
theme_update(panel.grid.major=element_line(0), panel.grid.minor=element_line(0))

# color palettes
type_color <- c("#A65628", "#984EA3", "#4DAF4A")
site_color <- c("#8DD3C7", "#FB8072")
time_color <- c("#bbdb15", "#ABDDA4", "#66C2A5", "#3288BD", "#5E4FA2")
dis_color <- c("#D95F02", "#1B9E77")

```


# Load Phyloseq
```{r}
load("./data/VarSamp_ps_assn.RData")
ps_assn

# remove ASVs with <5 reads
ps <- ps_assn
ps <- prune_taxa(taxa_sums(ps)>=5, ps) # removes 163 taxa
#sort(sample_sums(ps))
ps

# load deseq
load("./data/VarSamp_dds.RData")
#plotDispEsts(dds)

## VST & Euclidean of VST
VST <- getVarianceStabilizedData(dds)
VST <- t(VST)  #taxa as columns
dist <- stats::dist(VST, method="euclidean")
```

#### Create dataframes outside phyloseq
```{r, echo=FALSE, results='hide'}
# create SbyE and SbyS from removed-low-abun-taxa phyloseq
SbyS <- (as(otu_table(ps), "matrix"))
SbyE <- (as(sample_data(ps), "data.frame"))

# sanity check, must be true
identical(sort(rownames(SbyE)), sort(rownames(ps@otu_table)))

# add diversity (from full diversity phyloseq obj)
SbyE$Sdiv <- specnumber((ps_assn@otu_table@.Data))
SbyE$Hdiv <- diversity((ps_assn@otu_table@.Data))
SbyE$Pdiv <- SbyE$Hdiv/log(SbyE$Sdiv)

#str(SbyE)
```

```{r subset, echo=FALSE, results='hide'}
##* Examine within-type individually -- don't re-calculate VST

# Debris
SbyE %>% filter(typeSample == "debris") -> SbyE_d  #lose rownames
SbyE_d <- droplevels(SbyE_d)
rownames(SbyE_d) <- SbyE_d$ID
VST_d <- VST[row.names(VST) %in% SbyE_d$ID,]
SbyS_d <- SbyS[row.names(SbyS) %in% SbyE_d$ID,]
SbyS_d <- SbyS_d[ , colSums(SbyS_d)>0]
identical(sort(rownames(SbyE_d)), sort(rownames(VST_d))) # must be TRUE
dist_d <- stats::dist(VST_d, method="euclidean")
dist;dist_d      #  sanity check, same values

# Leaves
SbyE %>% filter(typeSample == "leaf") -> SbyE_l
SbyE_l <- droplevels(SbyE_l)
rownames(SbyE_l) <- SbyE_l$ID
VST_l <- VST[row.names(VST) %in% SbyE_l$ID,]
identical(sort(rownames(SbyE_l)), sort(rownames(VST_l))) # must be TRUE
dist_l <- stats::dist(VST_l, method="euclidean")

# Heads
SbyE %>%   
  filter(typeSample == "head") -> SbyE_h
SbyE_h <- droplevels(SbyE_h)
rownames(SbyE_h) <- SbyE_h$ID
VST_h <- VST[row.names(VST) %in% SbyE_h$ID,]
identical(sort(rownames(SbyE_h)), sort(rownames(VST_h))) # must be TRUE
dist_h <- stats::dist(VST_h, method="euclidean")

# Heads with Low Disease at T5 only
SbyE_h %>%   
  filter(DiseaseStatus == "Lo" | DiseaseStatus == "") -> SbyE_h_lo
SbyE_h_lo <- droplevels(SbyE_h_lo)
rownames(SbyE_h_lo) <- SbyE_h_lo$ID
VST_h_lo <- VST_h[row.names(VST_h) %in% SbyE_h_lo$ID,]
identical(sort(rownames(SbyE_h_lo)), sort(rownames(VST_h_lo))) # must be TRUE
dist_h_lo <- stats::dist(VST_h_lo, method="euclidean")

# Heads with T5 time only
SbyE_h %>%   
  filter(timeSample == "T5") -> SbyE_h_t5
SbyE_h_t5 <- droplevels(SbyE_h_t5)
rownames(SbyE_h_t5) <- SbyE_h_t5$ID
VST_h_t5 <- VST_h[row.names(VST_h) %in% SbyE_h_t5$ID,]
identical(sort(rownames(SbyE_h_t5)), sort(rownames(VST_h_t5))) # must be TRUE
dist_h_t5 <- stats::dist(VST_h_t5, method="euclidean")

```

# MB ~ Site x Var x Time

* Note: can't test Tissue alone, varpart needs >1 Xmat table for test to comparisons.

### Debris
```{r}
# #dummy vrbl coding
XSite_d <- model.matrix(~ site, SbyE_d)[,-1] #1columns, 
XVar_d <- model.matrix(~ variety.x, SbyE_d)[,-1] #2columns, 
XTime_d <- model.matrix(~ timeSample, SbyE_d)[,-1] #1columns,

#perform variance partitioning on distance matrix
VP_d <- varpart(dist_d, ~XSite_d, ~XVar_d, ~XTime_d)

# results
VP_d$part
```
```{r, echo = FALSE}
# plot results
#showvarparts(3)
plot(VP_d, bg=2:4, Xnames = c("Site", "Variety", "Time"), cex = 1.5)
title("Debris", adj = 0)
```

* Site explains 26.4% of variation in debris community, variety 0.6%, time 9.7%

```{r}
# #whole model signif test
vp1_d <- capscale(dist_d ~ XSite_d + XVar_d + XTime_d,
           data = SbyE_d, comm = VST_d)   
#same variance and F-value if raw SbyS used, comm data is just for plotting
anova(vp1_d, permutations = 999)

# #Conditional Fraction signif test 
# this first one tests the variance explained by Site conditioned on (or given) the variance explained by Variety and Time
vp2_d <- capscale(dist_d ~ XSite_d +
           Condition(cbind(XVar_d, XTime_d)),
           data = SbyE_d, comm = VST_d)
anova(vp2_d, permutations = 999)

# this one tests the variance explained by Variety|(Site & Time)
vp3_d <- capscale(dist_d ~ XVar_d +
           Condition(cbind(XSite_d, XTime_d)),
           data = SbyE_d, comm = VST_d)
anova(vp3_d, permutations = 999)

# this one tests the variance explained by Time|(Site & Variety)
vp4_d <- capscale(dist_d ~ XTime_d +
           Condition(cbind(XSite_d, XVar_d)),
           data = SbyE_d, comm = VST_d)
anova(vp4_d, permutations = 999)
```

* Given its low overall importance, variety marginally significantly explains variation in debris community.


### Leaves
```{r}
# #dummy vrbl coding
XSite_l <- model.matrix(~ site, SbyE_l)[,-1] #1columns, 
XVar_l <- model.matrix(~ variety.x, SbyE_l)[,-1] #2columns, 
XTime_l <- model.matrix(~ timeSample, SbyE_l)[,-1] #3columns,

#perform variance partitioning on distance matrix
VP_l <- varpart(dist_l, ~XSite_l, ~XVar_l, ~XTime_l)

# results
VP_l$part
```
```{r, echo = FALSE}
# plot results
#showvarparts(3)
plot(VP_l, bg=2:4, Xnames = c("Site", "Variety", "Time"), cex = 1.5)
title("Leaves", adj = 0)
```

* Site explains 7.34% of variation in leaf community, variety 0.3%, time 9.2%

```{r}
# #whole model signif test
vp1_l <- capscale(dist_l ~ XSite_l + XVar_l + XTime_l,
           data = SbyE_l, comm = VST_l)   
#same variance and F-value if raw SbyS used, comm data is just for plotting
anova(vp1_l, permutations = 999)

# #Conditional Fraction signif test 
# this first one tests the variance explained by Site conditioned on (or given) the variance explained by Variety and Time
vp2_l <- capscale(dist_l ~ XSite_l +
           Condition(cbind(XVar_l, XTime_l)),
           data = SbyE_l, comm = VST_l)
anova(vp2_l, permutations = 999)

# this one tests the variance explained by Variety|(Site & Time)
vp3_l <- capscale(dist_l ~ XVar_l +
           Condition(cbind(XSite_l, XTime_l)),
           data = SbyE_l, comm = VST_l)
anova(vp3_l, permutations = 999)

# this one tests the variance explained by Time|(Site & Variety)
vp4_l <- capscale(dist_l ~ XTime_l +
           Condition(cbind(XSite_l, XVar_l)),
           data = SbyE_l, comm = VST_l)
anova(vp4_l, permutations = 999)
```

* Variety does NOT significantly explains variation in leaf community.


### Heads
* As with the structure results, testing only the low disease heads at T5 (asserting that those are the "normal' status of heads in the field)
* Then, will separately testing whether high disease has an outsize effect on the microbiome at T5 timepoint, relative to low disease heads
```{r}
# #dummy vrbl coding
XSite_h_lo <- model.matrix(~ site, SbyE_h_lo)[,-1] #1columns, 
XVar_h_lo <- model.matrix(~ variety.x, SbyE_h_lo)[,-1] #2columns, 
XTime_h_lo <- model.matrix(~ timeSample, SbyE_h_lo)[,-1] #2columns,

#perform variance partitioning on distance matrix
VP_h_lo <- varpart(dist_h_lo, ~XSite_h_lo, ~XVar_h_lo, ~XTime_h_lo)

# results
VP_h_lo$part
```
```{r, echo = FALSE}
# plot results
#showvarparts(3)
plot(VP_h_lo, bg=2:4, Xnames = c("Site", "Variety", "Time"), cex = 1.5)
title("Heads", adj = 0)
```

* Site explains 9.34% of variation in head community, variety 1.21%, time 10.78%

```{r}
# #whole model signif test
vp1_h_lo <- capscale(dist_h_lo ~ XSite_h_lo + XVar_h_lo + XTime_h_lo,
           data = SbyE_h_lo, comm = VST_h_lo)   
#same variance and F-value if raw SbyS used, comm data is just for plotting
anova(vp1_h_lo, permutations = 999)

# #Conditional Fraction signif test 
# this first one tests the variance explained by Site conditioned on (or given) the variance explained by Variety and Time
vp2_h_lo <- capscale(dist_h_lo ~ XSite_h_lo +
           Condition(cbind(XVar_h_lo, XTime_h_lo)),
           data = SbyE_h_lo, comm = VST_h_lo)
anova(vp2_h_lo, permutations = 999)

# this one tests the variance explained by Variety|(Site & Time)
vp3_h_lo <- capscale(dist_h_lo ~ XVar_h_lo +
           Condition(cbind(XSite_h_lo, XTime_h_lo)),
           data = SbyE_h_lo, comm = VST_h_lo)
anova(vp3_h_lo, permutations = 999)

# this one tests the variance explained by Time|(Site & Variety)
vp4_h_lo <- capscale(dist_h_lo ~ XTime_h_lo +
           Condition(cbind(XSite_h_lo, XVar_h_lo)),
           data = SbyE_h_lo, comm = VST_h_lo)
anova(vp4_h_lo, permutations = 999)
```

* All three factor variables tested, including variety, significantly explain variation in head community.


### T5 Heads
```{r}
# #dummy vrbl coding
XSite_h_t5 <- model.matrix(~ site, SbyE_h_t5)[,-1] #1columns, 
XVar_h_t5 <- model.matrix(~ variety.x, SbyE_h_t5)[,-1] #2columns, 
XDis_h_t5 <- model.matrix(~ DiseaseStatus, SbyE_h_t5)[,-1] #1columns,

#perform variance partitioning on distance matrix
VP_h_t5 <- varpart(dist_h_t5, ~XSite_h_t5, ~XVar_h_t5, ~XDis_h_t5)

# results
VP_h_t5$part
```
```{r, echo = FALSE}
# plot results
#showvarparts(3)
plot(VP_h_t5, bg=2:4, Xnames = c("Site", "Variety", "Disease"), cex = 1.5)
title("T5 Heads", adj = 0)
```

* Site explains 13.31% of variation in T5 head community, variety 0.12%, disease 2.73%

```{r}
# #whole model signif test
vp1_h_t5 <- capscale(dist_h_t5 ~ XSite_h_t5 + XVar_h_t5 + XDis_h_t5,
           data = SbyE_h_t5, comm = VST_h_t5)   
#same variance and F-value if raw SbyS used, comm data is just for plotting
anova(vp1_h_t5, permutations = 999)

# #Conditional Fraction signif test 
# this first one tests the variance explained by Site conditioned on (or given) the variance explained by Variety and Disease
vp2_h_t5 <- capscale(dist_h_t5 ~ XSite_h_t5 +
           Condition(cbind(XVar_h_t5, XDis_h_t5)),
           data = SbyE_h_t5, comm = VST_h_t5)
anova(vp2_h_t5, permutations = 999)

# this one tests the variance explained by Variety|(Site & Disease)
vp3_h_t5 <- capscale(dist_h_t5 ~ XVar_h_t5 +
           Condition(cbind(XSite_h_t5, XDis_h_t5)),
           data = SbyE_h_t5, comm = VST_h_t5)
anova(vp3_h_t5, permutations = 999)

# this one tests the variance explained by Disease|(Site & Variety)
vp4_h_t5 <- capscale(dist_h_t5 ~ XDis_h_t5 +
           Condition(cbind(XSite_h_t5, XVar_h_t5)),
           data = SbyE_h_t5, comm = VST_h_t5)
anova(vp4_h_t5, permutations = 999)
```

* Variety does NOT significantly explains variation in the dough-filling developmental stage (T5) of the head community. But disease DOES significantly explain variation.



# Figure
```{r}
v1 <- data.frame(type = c(rep("Debris",4)), var = c('Site', 'Variety', 'Time', 'Resid.'),
    part = VP_d$part$indfract$Adj.R.square[c(1:3,8)]*100 )
v2 <- data.frame(type = c(rep("Leaf",4)), var = c('Site', 'Variety', 'Time', 'Resid.'),
    part = VP_l$part$indfract$Adj.R.square[c(1:3,8)]*100 )
v3 <- data.frame(type = c(rep("Head",4)), var = c('Site', 'Variety', 'Time', 'Resid.'),
    part = VP_h_lo$part$indfract$Adj.R.square[c(1:3,8)]*100 )
v4 <- data.frame(type = c(rep("T5.Head",4)), var = c('Site', 'Variety', 'Disease', 'Resid.'),
    part = VP_h_t5$part$indfract$Adj.R.square[c(1:3,8)]*100 )

#format for plot
out <- rbind(v1,v2,v3)
out$var <- factor(out$var, levels = c('Site', 'Time', 'Variety', 'Resid.'))
out$part_char <- paste0(format(round(out$part,1), nsmall =1), 
                       c("*","","*","",  "*","","*","",  "*","*","*",""))

v4$var <- factor(v4$var, levels = c('Site', 'Disease', 'Variety', 'Resid.'))
v4$part_char <- paste0(format(round(v4$part,1), nsmall =1),
                       c("*","","*",""))

p1 <- ggplot(out, aes(x = type, y = part, fill = var, label = part_char)) +
    geom_bar(stat = "identity", position = "stack") +
    #geom_text(size = 2.2, position = position_stack(vjust = 0.5)) +
    scale_x_discrete("") + scale_y_continuous('Estimated Variance') +
    theme(axis.title.x = element_blank()) +
    scale_fill_manual("",values = c("#FDBF6F", "#B2DF8A", "#FB9A99", "gray70"))
p2 <- ggplot(v4, aes(x = type, y = part, fill = var, label = part_char)) +
    geom_bar(stat = "identity", position = "stack") +
    #geom_text(size = 2.2, position = position_stack(vjust = 0.5)) +
    scale_x_discrete("") + scale_y_continuous('') + 
    theme(axis.title = element_blank()) +
    scale_fill_manual("",values = c("#FDBF6F", "#A6CEE3", "#FB9A99", "gray70")) 

#tiff("./figures/VarPart_barPlots.tiff", width = 8, height = 8.5, units="cm", res=300)
grid.arrange(
    grobs = list(p1+guides(fill= 'none'), p2+guides(fill= 'none')),
    widths = c(2.5, 1))
#dev.off()

```


```{r}
sessionInfo()
```



#### End

